<%- include("../partials/header"); %>

<main>
    <!-- Checkout Form Section -->
    <div class="checkout-form">
      <% if (user) { %>
        <!-- User form for logged in users -->
          <% if (addresses && addresses.length > 0) { %>
            <!-- Address Selection for registered users with existing addresses -->
            <form method="POST" action="/address/shipping-address/default?_method=PATCH">
              <div class="address-selection">
                <h3>Select Shipping Address</h3>
                <select name="shippingAddressId" id="shippingAddress" required>
                  <% addresses.forEach(address => { %>
                    <option value="<%= address.id %>" 
                            <%= address.is_shipping ? 'selected' : '' %>  
                            data-is-shipping= "<%= address.is_shipping %>"> <!-- Show default shipping address as already selected -->
                            <%= address.first_name %>, <%= address.last_name %>,<%= address.address %>, <%= address.city %>
                    </option>
                  <% }); %>
                </select>
    
                <h3>Select Billing Address</h3>
                <select name="billingAddressId" id="billingAddress" required>
                  <% addresses.forEach(address => { %>
                    <option value="<%= address.id %>"
                            <%= address.is_billing ? 'selected' : '' %>
                            data.is_billing = "<%= address.is_billing %>"> <!-- Show default billing address as already selected -->
                            <%= address.first_name %>, <%= address.last_name %>,<%= address.address %>, <%= address.city %>
                    </option>
                  <% }); %>
                </select>
                <!-- Hidden update button, will only appear when default selections change -->
                <button type="submit" id="updateDefaultBtn" style="display: none;" class="btn btn-primary">
                  Update Default Addresses
                </button>
              </div>
          <% } else { %>
            <form method="POST" action="/address/shipping-address">
            <!-- Address selection for registered users without existing address-->
            <div class="new-address">
              <h3>Add Shipping Address</h3>

              <!-- Add fromCheckout input so that /address/ POST route knows the redirect user to checkout if the form came from here -->
              <input type="hidden" name="fromCheckout" value="true">
              
              <label>First Name:</label>
              <input type="text" name="firstName" value="<%= user.first_name %>" required>
              
              <label>Last Name:</label>
              <input type="text" name="lastName" value="<%= user.last_name %>" required>
          
              <label for="address">Address</label>
              <input type="text" name="address">
          
              <label for="city">City</label>
              <input type="text" name="city">
          
              <label for="county">County</label>
              <input type="text" name="county">
          
              <label for="phoneNumber">Phone:</label>
              <input type="text"  name="phoneNumber">
          
              <label for="postalCode">Postal code:</label>
              <input type="text" name="postalCode">
              <button type="submit">Save Address & Continue</button>
            </div>
          <% } %>
        </form>
        <% } else { %>
          <h2>Guest Checkout</h2>
          <p>You need to register or log in to complete your order.</p>
          <a href="/auth/register" class="btn btn-primary">Register</a>
          <a href="/auth/login" class="btn btn-secondary">Log In</a>
        <% } %>
    </div>



    <% if (user && addresses && addresses.length > 0) { %>
      <form method="POST" action="/orders/new-order" class="order-submission">
        <!-- Hidden inputs to pass selected addresses -->
        <input type="hidden" name="shippingAddressId" id="hiddenShippingAddressId">
        <input type="hidden" name="billingAddressId" id="hiddenBillingAddressId">
        <input type="hidden" name="paymentMethod" value="cash"> <!-- Default to cash -->
        
        <!-- Order submission button -->
        <button type="submit" class="btn btn-primary btn-place-order">
          Place Order
        </button>
      </form>
      <% } %>



        <!-- Checkout order details  -->
    <div class="checkout">
        <% if (cartItems.length > 0) { %>
            <table>
                <thead>
                  <tr>
                    <th>Produs</th>
                    <th>Sub-total</th>
                  </tr>
                </thead>
                <tbody>
                  <% cartItems.forEach(item => { %>
                    <tr>
                      <td>
                        <%= item.name %>
                        <strong>Ã—&nbsp;<%= item.quantity %></strong>
                      </td>
                      <td>
                        <%= item.total_price %> lei
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
                <tfoot>
                  <tr>
                    <th>Sub-total</th>
                    <td><%= cartTotal %> lei</td>
                  </tr>
                  <tr>
                    <th>Total</th>
                    <td><strong><%= cartTotal %> lei</strong></td>
                  </tr>
                </tfoot>
              </table>
        <% } else { %>
          <p> There are no products in your cart. </p>
       <% } %>      
    </div>

    <% if (user) { %>
      <!-- Payment Method Selection -->
      <div class="payment-options">
        <h3>Payment Method</h3>
        <select name="paymentMethod" id="paymentMethod" class="form-control" required>
          <option value="cash" selected>Cash on Delivery</option>
          <option value="card" disabled>Credit/Debit Card (Coming Soon)</option>
        </select>
        
        <!-- Card Payment Form (Hidden by default), shown only when card is selected. -->
         <!-- TODO: Implement card payment -->
        <div id="cardPaymentForm" style="display: none;">
          <div class="form-group">
            <label>Card Number</label>
            <input type="text" class="form-control" disabled>
          </div>
          <!-- TODO: Add rest of details -->
        </div>
      </div>
    <% } %>

</main>



<%- include("../partials/footer"); %>